{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    {# TODO favicon #}
    <link rel="icon" href="../../favicon.ico">
    <title>{% block title %}Destination Australia{% endblock %}</title>

    <!-- Bootstrap core CSS -->
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <!-- Bootstrap theme -->
    <link href="{% static 'css/bootstrap-theme.min.css' %}" rel="stylesheet">

    <!-- Custom styles -->
    {% block style %}<link href="{% static 'css/custom.css' %}" rel="stylesheet">{% endblock %}

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>
<body>

<div class="row" style="height: 100%;margin: 0 !important;padding: 0 !important;">
    <div class="col-sm-4 col-md-3" style="margin-top: 0 !important;padding: 2px !important;">
        <h1 class="travel_title">Destination Australia</h1>
        <h2 class="travel_title">Nos étapes</h2>
        <p>Tu peux cliquer sur les marqueurs de la carte ou bien directement dans la liste ci-dessous pour nous laisser des commentaire (n'hésite pas ça fait toujours plaisir :)</p>
        <div class="list-group">
            {% for segment in segment_list %}
                <a href="#" class="list-group-item" data-toggle="modal" data-target="#myModal{{ forloop.counter }}">{# TODO active #}
                    <img src="{{ segment.photo.url }}" style="height: 70px;{% if forloop.counter|divisibleby:'2' %}float:left;margin-right: 5px;{% else %}float:right;margin-left: 5px;{% endif %}">
                    <h4 class="list-group-item-heading">{{ segment }} <small>le {{ segment.end_date }}</small></h4>
                    <p class="list-group-item-text" style="text-align: justify;">{{ segment.text|truncatechars:'100' }}</p>
                </a>
                <!-- Modal -->
                <div class="modal fade" id="myModal{{ forloop.counter }}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title" id="myModalLabel">{{ segment }} <small>le {{ segment.end_date }}</small></h4>
                            </div>
                            <div class="modal-body">
                                <img src="{{ segment.photo.url }}" style="width: 100%;margin-bottom: 10px;">
                                <p class="text-primary" style="text-align: justify;margin-bottom: 10px;">{{ segment.text }}</p>
                            </div>
                            <div class="modal-footer">
                                <h4>Commentaires</h4>
                                {% for comment in segment.comment_set.all %}
                                    <div class="well well-sm">
                                        <p class="small text-muted">Commentaire posté par <b>{{ comment.user }}</b> le {{ comment.pub_date }}</p>
                                        <p class="text-primary">{{ comment.content }}</p>
                                    </div>
                                {% endfor %}
                                <form method="post" action="{% url 'travel:segment_comment' segment.slug %}" class="form-horizontal">
                                    {% if form.subject.errors %}
                                        <ol>
                                            {% for error in form.subject.errors %}
                                                <li><strong>{{ error|escape }}</strong></li>
                                            {% endfor %}
                                        </ol>
                                    {% endif %}
                                    <div class="panel panel-primary">
                                        <div class="panel-heading">
                                            <h2 class="panel-title">Commenter</h2>
                                        </div>
                                        <div class="panel-body">
                                            <fieldset>
                                                {% csrf_token %}
                                                <div class="form-group">
                                                    <label for="user" class="col-lg-2 control-label">Ton nom</label>
                                                    <div class="col-lg-10">
                                                        <input id="user" type="text" name="user" class="form-control" >
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label for="content" class="col-lg-2 control-label">Message</label>
                                                    <div class="col-lg-10">
                                                        <textarea id="content" name="content" class="form-control" rows="3"></textarea>
                                                    </div>
                                                </div>
                                                <button type="submit" class="btn btn-primary form-control">Commenter</button>
                                            </fieldset>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    <div class="col-sm-8 col-md-9" style="height: 100%;margin: 0 !important;padding: 0 !important;">
        <div id="map"></div>
    </div>
</div>

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="{% static 'js/bootstrap.min.js' %}"></script>
<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
<script src="{% static 'js/ie10-viewport-bug-workaround.js' %}"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="http://maps.googleapis.com/maps/api/js?sensor=false&libraries=places"></script>
<script>
    /* Ce code est vraiment ... ouais, je reprend ça quand j'ai le temps :-| */
    $( document ).ready(function() {
        var init = false;
        var directionsDisplay = new google.maps.DirectionsRenderer({suppressMarkers: true});
        var directionsService = new google.maps.DirectionsService();
        var map;
        successCallback();

        function successCallback() {
            var myOptions = {
                zoom: 15,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            var waypts = [];
            var markers = [];
            map = new google.maps.Map(document.getElementById("map"), myOptions);
            {% for segment in segment_list %}
                {% if segment != segment_list.last %}
                    waypts.push({
                        location:new google.maps.LatLng({{ segment.end_milestone.latitude|safe }}, {{ segment.end_milestone.longitude|safe }}),
                        stopover:true});
                {% endif %}
                markers.push({
                    position: new google.maps.LatLng({{ segment.end_milestone.latitude|safe }}, {{ segment.end_milestone.longitude|safe }}),
                    map: map,
                    title: '{{ segment }}',
                    image: '{{ segment.photo.url }}',
                    date: '{{ segment.end_date }}',
                    slug: '{{ segment.slug }}',
                    data: '{{ segment.text|escapejs }}'});
            {% endfor %}
            latitude_depart = {{ segment_list.first.start_milestone.latitude|safe }};
            longitude_depart = {{ segment_list.first.start_milestone.longitude|safe }};
            latitude_arrivee = {{ segment_list.last.end_milestone.latitude|safe }};
            longitude_arrivee = {{ segment_list.last.end_milestone.longitude|safe }};
            var request = {
                origin: new google.maps.LatLng(latitude_depart,longitude_depart,17),
                destination: new google.maps.LatLng(latitude_arrivee,longitude_arrivee,17),
                waypoints: waypts,
                optimizeWaypoints: true,
                travelMode: google.maps.TravelMode.WALKING
            };
            directionsDisplay.setMap(map);
            directionsService.route(request, function(result, status) {
                if (status == google.maps.DirectionsStatus.OK) {
                    directionsDisplay.setDirections(result);
                } else {
                    console.log(status);
                }
            });
            directionsDisplay.setPanel(document.getElementById("map-panel"));
            var infowindow = new google.maps.InfoWindow(), i, marker;
            for (i = 0; i < markers.length; i++) {
                marker = new google.maps.Marker({
                    position: new google.maps.LatLng(markers[i]['position']['A'], markers[i]['position']['F']),
                    map: map
                });
                google.maps.event.addListener(marker, 'click', (function(marker, i) {
                    return function() {
                        console.log(markers[i]['slug']);
                        infowindow.setContent('<div id="content">' +
                        '<h2 id="firstHeading" class="firstHeading">' + markers[i]['title'] + ' <small>le ' + markers[i]['date'] + '</small></h2>' +
                        '<img src="' + markers[i]['image'] +'" style="width:100px;float:left;margin:0 10px 10px 0;"">' +
                        '<div id="bodyContent" style="text-align: justify;">' + markers[i]['data'] + '</div>'+
                        '<p class="text-warning">Pour laisser un commentaire, clique sur cette étape dans la liste de gauche !</p>' + '</div>');
                        infowindow.open(map, marker);
                    }
                })(marker, i));
            }

            init = true;
        }
    });
</script>
</body>
</html>